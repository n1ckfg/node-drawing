<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>...</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta property="og:image" content="thumbnail.gif">
		<link rel="stylesheet" href="./css/main.css">
		<script src="./js/libraries/socket.io/socket.io.js"></script>			
		<script src="./js/libraries/p5js/p5.min.js"></script>
	</head>

	<body>
		<script>
			"use strict";

			const sW = 800;
			const sH = 800;
			let pg;
			let isDrawing = false;
			let currentStroke, localStrokes, remoteStrokes;
			const lifetime = 10000;

			function setup() {
				createCanvas(windowHeight, windowHeight);
				pg = createGraphics(sW, sH, WEBGL);

				pixelDensity(1);  
				noCursor();
				frameRate(60);

				background(0);  
				pg.strokeWeight(4);

				localStrokes = new StrokeCollection(lifetime);
				remoteStrokes = new StrokeCollection(lifetime);
			}

			function draw() {
				background(0);
				pg.background(0);

				if (mouseIsPressed && !isDrawing) {
					isDrawing = true;
					localStrokes.addStroke(new Stroke(0, color(255), []));
					localStrokes.updateStroke(mouseX, mouseY);
				} else if (mouseIsPressed && isDrawing) {
					localStrokes.updateStroke(mouseX, mouseY);
				} else if (!mouseIsPressed && isDrawing) {
					isDrawing = false;
				}

				localStrokes.run();
				remoteStrokes.run();

				image(pg, 0, 0, width, height);
			}

			function windowResized() {
				resizeCanvas(windowHeight, windowHeight);
			}

			class Stroke {

				constructor(id, color, points) {
					this.id = id;
					this.timestamp = millis();
					this.color = color;
					this.points = points;
				}

				run() {
					pg.stroke(this.color);
					pg.noFill();
					pg.beginShape(LINE_STRIP);

					for (let i=0; i<this.points.length; i++) {
						pg.vertex(this.points[i].x, this.points[i].y);
					}

					pg.endShape();
				}

				addPoint(x, y) {
					x -= width/2;
					y -= height/2;
					this.points.push(createVector(x, y));
				}

			}

			class StrokeCollection {

				constructor(lifetime) {
					this.strokes = [];
					this.lifetime = lifetime;
				}

				run() {
					const t = millis();

					for (let i=0; i<this.strokes.length; i++) {
						this.strokes[i].run();

						if (t > this.strokes[i].timestamp + this.lifetime) {
							this.strokes.splice(i, 1);
						}
					}
				}

				addStroke(stroke) {
					this.strokes.push(stroke);
				}

				updateStroke(x, y) {
					this.strokes[this.strokes.length - 1].addPoint(x, y);
				}

				removeStroke(id) {
					for (let i=0; i<this.strokes.length; i++) {
						if (this.strokes[i].id === id) {
							this.strokes.splice(i, 1);
						}
					}
				}

			}

			const socket = io();

			socket.on("ServerMessageExample", function(data) {
				console.log("Received message from server: " + data);
			});

			//const button = document.getElementById("button");
			//button.addEventListener("click", function() {
				//socket.emit("ClientMessageExample", "Hello from client");
			//});
		</script>
	</body>

</html>